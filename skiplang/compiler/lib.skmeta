{"name": "pkg-config", "target": "arm64-apple-darwin24.4.0", "hash": "367615819954349869", "pkg_dir": "/Users/cristianocalcagno/GitHub/skip/skiplang/pkg-config", "sources": [{"path": "src/lib.sk", "mtime": 1762777200, "contents": "module PkgConfig;\n\nclass Library{\n  // Libraries specified by -l\n  libs: Array<String>,\n  // Library search paths specified by -L\n  link_paths: Array<String>,\n  // Library file paths specified without -l\n  link_files: Array<String>,\n  // C/C++ header include paths specified by -I\n  include_paths: Array<String>,\n  // C/C++ definitions specified by -D\n  defines: Map<String, ?String>,\n  version: String,\n} {\n  static fun parse(libs_cflags: String, modversion: String): Library {\n    libs = mutable Vector[];\n    link_paths = mutable Vector[];\n    link_files = mutable Vector[];\n    include_paths = mutable Vector[];\n    defines = mutable Map[];\n\n    flags = split_flags(libs_cflags).flatMap(flag ->\n      if (flag.startsWith(\"-\") && flag.length() > 2) {\n        f = flag.take(2);\n        val = flag.stripPrefix(f);\n        Array[f, val]\n      } else {\n        Array[flag]\n      }\n    );\n\n    iter = flags.iterator();\n    loop {\n      flag = iter.next() match {\n      | Some(word) -> word\n      | None() -> break void\n      };\n      if (flag.startsWith(\"-\")) {\n        val = iter.next() match {\n        | Some(v) -> v\n        | None() -> invariant_violation(`Missing value for flag ${flag}`)\n        };\n        flag match {\n        | \"-l\" -> libs.push(val)\n        | \"-L\" -> link_paths.push(val)\n        | \"-I\" -> include_paths.push(val)\n        | \"-D\" ->\n          (k, v) = if (val.contains(\"=\")) {\n            (k, v) = val.splitFirst(\"=\");\n            (k, Some(v))\n          } else {\n            (val, None())\n          };\n          defines.set(k, v)\n        | _ -> invariant_violation(`Unrecognized flag ${flag}`)\n        }\n      } else {\n        link_files.push(flag)\n      }\n    };\n\n    Library{\n      libs => libs.collect(Array),\n      link_paths => link_paths.collect(Array),\n      link_files => link_files.collect(Array),\n      include_paths => include_paths.collect(Array),\n      defines => defines.chill(),\n      version => modversion.trim(),\n    }\n  }\n}\n\nclass Config(\n  statik_: ?Bool = None(),\n  min_version_: ?String = None(),\n  max_version_: ?String = None(),\n  skargo_metadata_: Bool = true,\n) {\n  fun statik(value: Bool = true): this {\n    this with {statik_ => Some(value)}\n  }\n\n  fun atleast_version(ver: String): this {\n    this with {min_version_ => Some(ver)}\n  }\n\n  fun atmost_version(ver: String): this {\n    this with {max_version_ => Some(ver)}\n  }\n\n  fun skargo_metadata(val: Bool = true): this {\n    this with {skargo_metadata_ => val}\n  }\n\n  fun probe(name: String): Result<Library, Error> {\n    libs_cflags = this.run(name, Array[\"--libs\", \"--cflags\"])?;\n    modversion = this.run(name, Array[\"--modversion\"])?;\n\n    res = Library::parse(libs_cflags, modversion);\n    if (this.skargo_metadata_) {\n      for (lib in res.libs) {\n        print_string(`skargo:skc-link-arg=-l${lib}`)\n      };\n      for (p in res.link_paths) {\n        print_string(`skargo:skc-link-arg=-L${p}`)\n      };\n      for (lib in res.link_files) {\n        print_string(`skargo:skc-link-lib=${lib}`)\n      }\n    };\n\n    Success(res)\n  }\n\n  private fun run(name: String, args: Array<String>): Result<String, Error> {\n    cmd = this.cmd().concat(Array[name]).concat(args);\n    p = System.subprocess(cmd) match {\n    | Success(p) -> p\n    | Failure _ -> return Failure(ErrorCommand(cmd.join(\" \")))\n    };\n\n    if (p.success()) {\n      Success(p.stdout)\n    } else {\n      Failure(ErrorProbeFailure(name, cmd.join(\" \"), p.stdout))\n    }\n  }\n\n  private fun cmd(): Array<String> {\n    res = mutable Vector[\"pkg-config\"];\n    this.statik_ match {\n    | Some(true) -> res.push(`--static`)\n    | _ -> void\n    };\n    this.min_version_ match {\n    | Some(ver) -> res.push(`--atleast-version ${ver}`)\n    | None() -> void\n    };\n    this.max_version_ match {\n    | Some(ver) -> res.push(`--max-version ${ver}`)\n    | None() -> void\n    };\n\n    res.collect(Array)\n  }\n}\n\nbase class Error {\n  children =\n  | ErrorCommand(cmd: String)\n  | ErrorProbeFailure(name: String, command: String, output: String)\n}\n\nprivate fun split_flags(output: String): Array<String> {\n  res = mutable Vector[];\n  word = mutable Vector[];\n  escaped = false;\n\n  for (c in output.chars()) {\n    c match {\n    | _ if (escaped) ->\n      !escaped = false;\n      word.push(c)\n    | '\\\\' -> !escaped = true\n    | '\\t' | '\\n' | '\\r' | ' ' ->\n      if (!word.isEmpty()) {\n        res.push(String::fromChars(word.collect(Array)));\n        word.clear()\n      }\n    | _ -> word.push(c)\n    }\n  };\n\n  res.collect(Array)\n}\n\nmodule end;\n"}], "env": [], "dependencies": [], "link": ["-lpthread", "-L/Users/cristianocalcagno/.local/lib", "-lskip_runtime64", "-lbacktrace"], "preambles": [], "has_object_code": false}