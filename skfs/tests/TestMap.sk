module SKStoreTest;

fun testMap(): mutable SKStore.Context {
  data = Array[
    (SKStore.IID(1), SKStore.IntFile(1)),
    (SKStore.IID(2), SKStore.IntFile(2)),
  ];
  SKStore.run(context ~> {
    dir1 = context.mkdir(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      SKStore.DirName::create("/dir1/"),
      data,
    );
    dir2 = dir1.map(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      context,
      SKStore.DirName::create("/dir2/"),
      (_context, writer, _, v) ~> writer.set(SKStore.IID(0), v.first),
    );
    _dir3 = dir2.map(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      context,
      SKStore.DirName::create("/dir3/"),
      (_context, writer, _key, values) ~> {
        writer.set(SKStore.IID(1), values.first)
      },
    );
  });
}

fun testMap2(): mutable SKStore.Context {
  dataStr1 = Array[
    (SKStore.IID(1), SKStore.StringFile("1")),
    (SKStore.IID(2), SKStore.StringFile("2")),
  ];
  dataStr2 = Array[
    (SKStore.IID(1), SKStore.StringFile("3")),
    (SKStore.IID(2), SKStore.StringFile("4")),
  ];
  SKStore.run(context ~> {
    dirStr1 = context.mkdir(
      SKStore.IID::keyType,
      SKStore.StringFile::type,
      SKStore.DirName::create("/dirStr1/"),
      dataStr1,
    );
    dirStr2 = context.mkdir(
      SKStore.IID::keyType,
      SKStore.StringFile::type,
      SKStore.DirName::create("/dirStr2/"),
      dataStr2,
    );
    dir1 = dirStr1.map(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      context,
      SKStore.DirName::create("/dir1/"),
      ((_context, writer, key, values) ~>
        writer.set(key, SKStore.IntFile(values.first.value.toInt()))),
    );
    dir2 = dirStr2.map(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      context,
      SKStore.DirName::create("/dir2/"),
      ((_, writer, key, values) ~>
        writer.set(key, SKStore.IntFile(values.first.value.toInt()))),
    );
    _dir3 = dir1.map(
      SKStore.IID::keyType,
      SKStore.IntFile::type,
      context,
      SKStore.DirName::create("/dir3/"),
      (context, writer, key, values) ~> {
        dirName = SKStore.DirName::create("/dir3/" + key + "/");
        _ = dir2.map(
          SKStore.IID::keyType,
          SKStore.IntFile::type,
          context,
          dirName,
          (_, writer, key, values) ~>
            writer.setArray(key, values.collect(Array))
          ,
        );
        writer.set(key, values.first);
      },
    );
  });
}
